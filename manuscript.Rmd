---
title             : "The title"
shorttitle        : "Title"

author: 
  - name          : "First Author"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "Postal address"
    email         : "my@email.com"
    role:         # Contributorship roles (e.g., CRediT, https://casrai.org/credit/)
      - Conceptualization
      - Writing - Original Draft Preparation
      - Writing - Review & Editing
  - name          : "Ernst-August Doelle"
    affiliation   : "1,2"
    role:
      - Writing - Review & Editing

affiliation:
  - id            : "1"
    institution   : "Wilhelm-Wundt-University"
  - id            : "2"
    institution   : "Konstanz Business School"

authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

  Enter author note here.

abstract: |
  One or two sentences providing a **basic introduction** to the field,  comprehensible to a scientist in any discipline.
  
  Two to three sentences of **more detailed background**, comprehensible  to scientists in related disciplines.
  
  One sentence clearly stating the **general problem** being addressed by  this particular study.
  
  One sentence summarizing the main result (with the words "**here we show**" or their equivalent).
  
  Two or three sentences explaining what the **main result** reveals in direct comparison to what was thought to be the case previously, or how the  main result adds to previous knowledge.
  
  One or two sentences to put the results into a more **general context**.
  
  Two or three sentences to provide a **broader perspective**, readily comprehensible to a scientist in any discipline.
  
  <!-- https://tinyurl.com/ybremelq -->
  
keywords          : "keywords"
wordcount         : "X"

bibliography      : ["references.bib"]

floatsintext      : no
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_pdf
---

```{r setup, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F, dpi=1200)

set.seed(123)
par(family = "Arial")
```

```{r pacman, eval=FALSE, include=FALSE}
#You need to run this chunk 1X in your system 
#install.packages("pacman")#Run this if you don't have pacman installed.
pacman::p_load(MOTE, tidyverse, psych, lavaan,kableExtra,gt,gtsummary, mirt,likert,kutils,semPlot,semTable,semTools,ggcorrplot,dlookr,qgraph,paran,EFA.MRFA,VIM,DiagrammeR,DiagrammeRsvg,ggplot2,cowplot,rsvg,questionr,magick, simsem,readxl, stringr,RColorBrewer,WrightMap, foreign,DT,SimDesign)
pacman::p_install_gh("jthomasmock/gtExtras")
pacman::p_install_gh("crsh/papaja")
pacman::p_install_gh("masiraji/tabledown")
pacman::p_install_gh("crsh/citr")

papaja::r_refs("references.bib")
#if you dont have LaTeX installed run the following lines
#install.packages("tinytex")
#tinytex::install_tinytex()
```



---
nocite: |
  `r cite_r("references.bib")`
  
---


# Methods
```{r data, include=F}
data = foreign::read.spss("Raw/Validity construct.sav", to.data.frame=TRUE)

write_csv(data, "Processeddata/part2.csv")

## Recoding data$CS9 into data$CS9_rec
data$CS9 <- fct_recode(data$CS9,
  "always" = "always_duplicated_4"
)

## Recoding com$Cs1 into com$Cs1_rec
data$Cs1 <- fct_recode(data$Cs1,
  "rarely" = "Rarely"
)

## Recoding com$CS23 into com$CS23_rec
data$CS23 <- fct_recode(data$CS23,
  "never" = "Never",
  "rarely" = "Rarely"
)

com <- data[,7:29]

names(com)[names(com) == "Cs1"] <- "CS01"
names(com)[names(com) == "Cs2"] <- "CS02"
names(com)[names(com) == "CS3"] <- "CS03"
names(com)[names(com) == "CS4"] <- "CS04"
names(com)[names(com) == "CS5"] <- "CS05"
names(com)[names(com) == "CS6"] <- "CS06"
names(com)[names(com) == "CS7"] <- "CS07"
names(com)[names(com) == "Cs8"] <- "CS08"
names(com)[names(com) == "CS9"] <- "CS09"
names(com)[names(com) == "Cs10"] <- "CS10"

code <- c(    "never"=1,
              "rarely"=2,
              "sometimes"=3,
              "often"=4,
              "always" =5)


com2 <- mutate(com, across(starts_with("CS"), ~unname(code[.])))

#write.csv(com2, "Processeddata/com_2.csv")


```

```{r descriptivrd}
desc <- data[,c(3, 5,6)]
## Recoding desc$Sex
desc$Sex <- fct_recode(desc$Sex,
  "Boy" = "male",
  "Girl" = "female"
)
colnames(desc) <- c("Gender", "Social Status", "Age")

des_tab <- desc %>%
  tbl_summary(
    by = Gender,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} ({p}%)"),
    type = list(Age ~ 'continuous'),
    digits = all_continuous() ~ 2,
    
    missing = "no"
    ) %>% add_overall() %>% bold_labels() %>% 
modify_header(label ~ "**Variable**")  %>%
  modify_caption("Demographic Characteristics") 
```

```{r gt-pic, include=F}
des_tab  %>%    # build gtsummary table
  as_gt() %>%             # convert to gt table
  gt::gtsave(             # save table as image
    filename = "Figures/demographics.png"
  )
```


```{r}
reliability <- psych::alpha(com2, check.keys = T)
```


```{r}

gt.data <- na.omit(com2)

#Creating long data
gt.data.long <- as.data.frame(gather(gt.data, Items, value))
gt.data.long$value <- as.numeric(as.character(gt.data.long$value))


gt.data.tab <- gt.data.long %>% 
  group_by(Items) %>% 
  # calculate summary stats & create data for the histogram and density plot
  dplyr::summarise(
    nr = n(),
    mean = mean(value, na.rm = TRUE),
    med = median(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    hist_data = list(value),
    dens_data = list(value),
    .groups = "drop"
  ) %>% 
  gt() 


gt.likert <-  as.data.frame(gt.data)


#gt.likert <-  mutate(gt.likert, across(starts_with("ASQ"), ~unname(recod[.])))

gt.likert.Factor = as.data.frame(lapply(gt.likert,factor,
                                     ordered = T))


#get the items name
gt.items <- names(gt.likert.Factor ) 
#Calculate percentage
gt.percentage <- kutils::likert(gt.likert.Factor, vlist = gt.items ) 

gt.percentage <- gt.percentage$table %>% 
  as.data.frame(.)

#data wrangling
labels <- c("never", "rarely","sometimes", "often", "always","Total")
as.data.frame(labels)

full.percentage <- cbind(labels,gt.percentage) #tables with labels  
full.percentage<- t(full.percentage ) #transpose
as.data.frame(full.percentage)
full.percentage1 <- full.percentage[-1,-6] #removing 1st row and total column
#full.percentage2 <- full.percentage1[, c(3, 4, 1, 2,5)]# rearranging
as.data.frame(full.percentage1)


colnames(full.percentage1) <- c("Never", "Rarely","Sometimes", "Often", "Always")

Items <- rownames(full.percentage1)
as.data.frame(Items)
full.percentage3 <- cbind(Items,full.percentage1)

full.percentage3 <- full.percentage3[order(Items),] 
full.percentage3 <- as.data.frame(full.percentage3[,-1]) %>% 
  gt()


gt.table <- gt.data.tab$'_data'
gt.liket <- full.percentage3$"_data"
Table <-  cbind( gt.table, gt.liket )%>% 
  gt()%>% 
  # histogram and density plots
  gtExtras::gt_sparkline(
    hist_data,
    type = "histogram",
    line_color = "black", 
    fill_color = "grey",
    bw = 1,
    same_limit = TRUE)%>%
  gtExtras::gt_sparkline(
    dens_data,
    type = "density",
    line_color = "black", 
    fill_color = "grey",
    bw = 0.75,
    same_limit = TRUE
  )%>%
  # format decimals
  fmt_number(columns = mean:sd, decimals = 1) %>%
  # header
  tab_header(
    title = md("**Communication**"),
    subtitle = md("Summary Descriptives")
  ) %>% 
  tab_footnote(
    footnote = md("**Histogram**"),
    locations = cells_column_labels(columns = hist_data)
  ) %>%
  tab_footnote(
    footnote = md("**Density**"),
    locations = cells_column_labels(columns = dens_data)
  ) %>% 
  #create groups of columns
  tab_spanner(
    label = "Items",
    columns = Items
  ) %>%
  tab_spanner(
    label = "Summary Statistics",
    columns = nr:sd
  ) %>%
  tab_spanner(
    label = "Graphics",
    columns = hist_data:dens_data
  )  %>%
  # change column names to appear in the table
  cols_label(
    Items = ("Items"),
    nr = ("n"),
    mean = ("Mean"),
    med = ("Median "),
    sd = (("SD")),
    hist_data = "Histogram",
    dens_data = "Density"
  ) %>%
  
  tab_spanner(
    label = "Response Pattern",
    columns = "Never":"Always"
  ) %>%
  # set alignment as per wish
  cols_align(
    align = "center",
    columns = everything()
  ) %>%
  opt_align_table_header(align = "left") %>%
  gtExtras::gt_plt_dot(
    mean,
    Items,
    palette = "ggthemes::fivethirtyeight")%>%gtsave("Figures/communication.png",vwidth = 7000)
  
```

```{r}

apatheme=theme_bw()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        #text=element_text(family = "Helvetica"),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title=element_blank(),
        axis.line.x = element_line(color='black'),
        axis.line.y = element_line(color='black'),
        panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 1))

```


```{r EFAdata, include=FALSE}
### EFA data
EFA.data <- com2
#library(VIM)
missing <- VIM::aggr(EFA.data, plot =T)

```

```{r EFAassumptions, include=FALSE}

#KMO test
KMO <- psych::KMO(EFA.data) 

# Test of correlation matrix
bartlet <- psych::cortest.bartlett(EFA.data, n =202)


#Histogram
#psych::multi.hist(EFA.data[,sapply(EFA.data, is.numeric)])

# Univariate normality

#creating normality function
shapiro_test_df <- function(df, bonf= TRUE, alpha= 0.05) {
  l <- lapply(df, shapiro.test)
  s <- do.call("c", lapply(l, "[[", 1))
  p <- do.call("c", lapply(l, "[[", 2))
  if (bonf == TRUE) {
    sig <- ifelse(p > alpha / length(l), "H0", "*")
  } else {
    sig <- ifelse(p > alpha, "H0", "*")
  }
  return(list(statistic= s,
              p.value= p,
              significance= sig,
              method= ifelse(bonf == TRUE, "Shapiro-Wilks test with Bonferroni Correction",
                             "Shapiro-Wilks test without Bonferroni Correction")))
}


Shapiro.efa <- shapiro_test_df(EFA.data)


efa.normality.tab = matrix(nrow = 48, ncol = 2)
rownameprefix <- "Item"
rownamesufix <- seq(1:48)
my.item.names <- paste(rownameprefix,rownamesufix, sep = "" )
rownames(efa.normality.tab) <- my.item.names
colnames(efa.normality.tab) <- c("statistic", "p")

efa.normality.tab[,1] <- apa(Shapiro.efa$statistic,2,T)
efa.normality.tab[,2] <- apa(Shapiro.efa$p.value,2,T)

efa.normalityprefix <- efa.normality.tab[,1]
efa.normalitysufix <- Shapiro.efa$significance
efa.normality.stat <- paste(efa.normalityprefix,efa.normalitysufix, sep = "" )

# Multivariate Normality
mardia <- psych::mardia(EFA.data, na.rm = T, plot =F)

# Descriptive Stats
Descriptives <- psych::describe(EFA.data)
alpha <- psych::alpha(EFA.data,check.keys=TRUE)
Item.total <- alpha$item.stats

Des.combined <- cbind(apa(Descriptives$mean,2,T), apa(Descriptives$sd,2,T), apa(Descriptives$skew,2,T),apa(Descriptives$kurtosis,2,T), efa.normality.stat,  apa(Item.total$r.cor,2,T))

colnames(Des.combined) = c("Mean", "SD", "Skew", "Kurtosis", "Shapiro-Wilk Statistics","Item-Total Correlation")
rownameprefix <- "Item"
rownamesufix <- seq(1:48)
my.names <- paste(rownameprefix,rownamesufix, sep = "" )
rownames(Des.combined) = (my.names)
```

## Item Analysis
`

```{r Cronbach, results='asis', width = 60}
Cron.bach <- psych::alpha(EFA.data,check.keys=TRUE) 
Cron.bach$total %>% 
  knitr::kable(caption = "Alpha", digits = 2) %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F)
Cron.bach$alpha.drop %>% 
  knitr::kable(caption = "Alpha value if item is dropped", digits = 2) %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F)

Cron.bach$item.stats %>% 
  knitr::kable(caption = "Corrected Item total Correlation", digits = 2) %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F)

Cron.bach$item.stats$r.cor
low.r.corec <- (min(Cron.bach$item.stats$r.cor))  #minimum item total correlation
high.r.corec <- (max(Cron.bach$item.stats$r.cor))     # maximum item total correlation
  
```

```{r CorrMatrix, include=FALSE}
#Polychoric Correlation matrix

correlations <- psych::polychoric(EFA.data, correct = 0)
upper <- correlations$rho[upper.tri(correlations$rho, diag = F)]

min.cor <- apa(min(abs(upper)),2,F) #minimum cor.coefficient of the matrix
max.cor <- apa(max(abs(upper)),2,F) # max. correlation coefficient of the matrix

determinets <- det(correlations$rho) 
# Calculating the percentage of correlations higher than .30

BigR = sum(correlations$rho >= abs(.30) & correlations$rho < abs(1.0), na.rm =T)/2 
totR = length(EFA.data)*(length(EFA.data)-1)/2
cor.per <- print (BigR/totR)*100
```


```{r figCor, out.height="150%",out.width="100%",fig.cap= "Correlation plot of the items",results='asis', fig.align='center'}

ggcorrplot(correlations$rho, hc.order = TRUE, outline.col = "white", type = "lower", 
           ggtheme = ggplot2::theme_minimal, tl.cex = 6,tl.srt = 90,colors = c("red", "white", "blue") )
#p.mat <- cor_to_p(correlations$rho, 428, method = "polychoric")
#to show pvalue in the fig add p.mat=p.mat
```



```{r ParallelEFA, include=FALSE}

# Parallel analysis
Horn <- paran(EFA.data, iterations=500, centile=0, quietly=FALSE,
           status=TRUE, all=FALSE, cfa=FALSE, graph=TRUE,
           color=TRUE, col=c("black","red","blue"),
           lty=c(1,2,3), lwd=1, legend=TRUE, 
           width=640, height=640, grdevice=png, seed=0, mat=NA, n=NA)


Adjusted.EV <- data.frame(Horn$AdjEv)
Adjusted.EV$type = c('Adjusted Ev')
Adjusted.EV$num = c(row.names(Adjusted.EV))
Adjusted.EV$num = as.numeric(Adjusted.EV$num)
colnames(Adjusted.EV) = c('eigenvalue', 'type', 'num')


Random.EV <- data.frame(Horn$RndEv)
Random.EV$type = c('Random EV')
Random.EV$num = c(row.names(Random.EV))
Random.EV$num = as.numeric(Random.EV$num)
colnames(Random.EV) = c('eigenvalue', 'type', 'num')


Unadjusted.EV <- data.frame(Horn$Ev)
Unadjusted.EV$type = c('Unadjusted EV')
Unadjusted.EV$num = c(row.names(Unadjusted.EV))
Unadjusted.EV$num = as.numeric(Unadjusted.EV$num)
colnames(Unadjusted.EV) = c('eigenvalue', 'type', 'num')



parallel = ggplot(Adjusted.EV, aes(x=num, y=eigenvalue, shape=type, color=type)) +
  #Add lines connecting data points
  geom_line()+
    geom_line(data = Random.EV) +
  geom_line(data = Unadjusted.EV)+
    #Add the data points.
  geom_point(size=1)+
  geom_point(data = Random.EV, size=1)+
  geom_point(data = Unadjusted.EV, size=1)+
  scale_y_continuous(name="Eigen Value", limits=c(0, 10), breaks=seq(0,10,2)) +
   #Label the x-axis 'Factor Number', and ensure that it ranges from 1-max # of factors, increasing by one with each 'tick' mark.
  scale_x_continuous(name='Factor Number', limits=c(0, 48),breaks=seq(0,48,4))+
    #Add vertical line indicating parallel analysis suggested max # of factors to retain
  geom_hline(yintercept=1, linetype = 'dashed') + apatheme 

```

```{r ScreePlot, include=FALSE}
Scree <- scree(correlations$rho,factors=TRUE,pc=TRUE,main="(B)",
      hline=NULL,add=F)


FA.Scree <- data.frame(Scree$fv)
FA.Scree$type = c('Factor Analysis')
FA.Scree$num = c(row.names(FA.Scree))
FA.Scree$num = as.numeric(FA.Scree$num)
colnames(FA.Scree) = c('eigenvalue', 'type', 'num')

PA.Scree <- data.frame(Scree$pcv)
PA.Scree$type = c('Principal Component Analysis')
PA.Scree$num = c(row.names(PA.Scree))
PA.Scree$num = as.numeric(PA.Scree$num)
colnames(PA.Scree) = c('eigenvalue', 'type', 'num')


scree.plot <-ggplot(FA.Scree, aes(x=num, y=eigenvalue,color=type, shape=type))+
   geom_line()+
  geom_line(data = PA.Scree)+ 
  geom_point(size=1)+
  geom_point(data = PA.Scree, size=1)+
  scale_y_continuous(name="Eigen Value", limits=c(0, 10), breaks=seq(0,10,2)) +
  scale_x_continuous(name='Factor Number', limits=c(0, 48),breaks=seq(0,48,4))+
  geom_hline(yintercept=1, linetype = 'dashed') + apatheme 
```

```{r HullEFA, include=FALSE}
# HULL
EFA.MRFA::hullEFA(EFA.data,extr = "ULS", index_hull = "CAF", display = TRUE, graph = T,
        details = TRUE)
hull <- ggplot2::last_plot()
Hull <- hull+ ggtitle(NULL) +xlab("Factor Number")+ylab("CAF")+ 
  apatheme +scale_color_manual(labels = c("Out side the convex Hull", "On the convex Hull"), values = c("red", "cyan2")) 
```

```{r MAPefa, include=FALSE}
#MAP
psych::VSS(EFA.data, rotate = "varimax", fm = 'minres', n.obs =202 )
```


## Network graph
```{r Network Graph,message=FALSE, warning=FALSE, width = 60}
library(EGAnet)
library(sna)
EGA(correlations$rho, n= 150, plot.EGA = T, algorithm.args = list(steps = 10))
ega <-ggplot2::last_plot()
```


```{r facIdFig, out.height="250%", out.width="100%",fig.align='center', fig.cap='Factor Identification (A) Parallel analysis (B) Scree Plot (C) Hull Method' (D) Network Analysis,  warning=FALSE, results= 'asis'}
cowplot::plot_grid(parallel, scree.plot,Hull,ega, labels = "AUTO",ncol=1, label_size = 8,align = "v")

```

 ( Figure \@ref(fig:facIdFig)). Horn's parallel analysis [@hornRationaleTestNumber1965] with 500 iterationsindicated a four factor solution. However, Scree plot, the minimum average partial (MAP) method [@velicerDeterminingNumberComponents1976] and Hull method [@lorenzo-sevaHullMethodSelecting2011] suggested a one-factor solution. 

```{r EFA, include=FALSE}
fa.3F.1 <- fa(r=correlations$rho, nfactors = 3, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE)
AA <- print(fa.3F.1, cut = .3, digits = 3, sort = TRUE)


reduced.model.3F.1 <- dplyr::select(EFA.data ,
                                    -c( CS21, CS13, CS10, CS19, CS03,CS09, CS05, CS23))

correlations.red.3F.1 <- polychoric(reduced.model.3F.1,correct = 0)

fa.3F.2 <- fa(r=correlations.red.3F.1$rho, nfactors = 3, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, max.iter = 100)

BB <- print(fa.3F.2, cut = .3, digits = 3, sort = TRUE)

reduced.model.3F.2 <- dplyr::select(EFA.data ,
                                    -c( CS21, CS13, CS10, CS19, CS03,CS09, CS05, CS23, CS02, CS01,CS15,CS20,CS12))


correlations.red.3F.2 <- polychoric(reduced.model.3F.2,correct = 0)


fa.3F.3 <- fa(r=correlations.red.3F.2$rho, nfactors = 3, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, max.iter = 500 )

CC <- print(fa.3F.3, cut = .3, digits = 3, sort = TRUE)

var1 <- CC$Vaccounted[2,1]*100
var2 <- CC$Vaccounted[2,2]*100
var3 <- CC$Vaccounted[2,3]*100
var4 <- CC$Vaccounted[2,4]*100
var5 <- CC$Vaccounted[2,5]*100
```


```{r EFA2f, include=FALSE}
fa.2F.1 <- fa(r=correlations$rho, nfactors = 2, fm= "pa",rotate ="promax",
              residuals = TRUE, SMC = TRUE)
AA <- print(fa.2F.1, cut = .3, digits = 3, sort = TRUE)


reduced.model.2F.1 <- dplyr::select(EFA.data ,
                                    -c( CS07, CS13, CS16, CS05, CS10, CS19, CS03, CS02, CS09, CS23))

correlations.red.2F.1 <- polychoric(reduced.model.2F.1)

fa.2F.2 <- fa(r=correlations.red.2F.1$rho, nfactors = 2, fm= "pa",rotate ="promax",
              residuals = TRUE, SMC = TRUE, max.iter = 100)

BB <- print(fa.2F.2, cut = .3, digits = 3, sort = TRUE)

reduced.model.2F.2 <- dplyr::select(EFA.data ,
                                    -c( CS07, CS13, CS16, CS05, CS10, CS19, CS03, CS02, CS09, CS23, CS17, CS04))


correlations.red.2F.2 <- polychoric(reduced.model.2F.2)


fa.2F.3 <- fa(r=correlations.red.2F.2$rho, nfactors = 2, fm= "pa",rotate ="promax",
              residuals = TRUE, SMC = TRUE, max.iter = 500 )

CC <- print(fa.2F.3, cut = .3, digits = 3, sort = TRUE)




```


```{r samplesizeIRT, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide', width=60}
set.seed(222)
m <-  23 # item number
n <- c(50, 75, 100, 150, 200, 300, 350) # sample size
design <- as.data.frame(n)


irtGenerate <- function(condition, fixed_objects = FALSE) {
n <- condition$n

a <- matrix(rlnorm(m,.2,.3))
diffs <- t(apply(matrix(runif(m*4, .3, 1), m), 1, cumsum))
diffs <- -(diffs - rowMeans(diffs))
diffs<- diffs + rnorm(m)
d <- diffs
dat <- simdata(a, d, n, itemtype = 'graded')
return(dat)
}

irtAnalyze <- function(condition, dat, fixed_objects = NULL) {
mod <- mirt(dat, 1, itemtype = 'graded', verbose = FALSE)
simpars <- coef(mod, simplify = TRUE, digits = Inf)$items
irtpars <- c(a = simpars[,1], d = simpars[,2])
return(irtpars)
}

irtSummarize <- function(condition, results,
fixed_objects = NULL) {
apop <- fixed_objects['alpha', ]
dpop <- fixed_objects['d', ]
simrmse <- RMSE(results, c(apop, dpop))
out <- c(RMSE = simrmse)
return(out)
}


simres <- runSimulation(design, replications = 100,
parallel = TRUE, generate = irtGenerate,
analyse = irtAnalyze, summarise = irtSummarize,
packages = c('mirt'))
simres


colind <- grep(".a.", colnames(simres))
sima <- as.data.frame(simres[, colind])
nvec <- as.numeric(simres$n)

meanRMSE <- rowMeans(sima)
names(meanRMSE) <- n
round(meanRMSE, 2)
matplot(nvec, log(sima), type = "l", col = 1, lty = 1,
ylab = "log(RMSE)", xlab = "sample size",
main = "Graded Response Model", xaxt = "n")
axis(1, at = nvec)
```

To gather more information on our retained one-factor solution, we sought Item Response Theory (IRT). IRT complements the conventional classical test theory-based analysis by gathering information on item discrimination and item difficulty. IRT judges an item's quality by providing item information in the light of participants' trait level ($\theta$). We gathered evidence on item quality as well as item fit, person fit and model by fitting a graded response model  in RStudio with the "mirt" package [@R-mirt]  [@R-mirt]. We did a Monte Carlo simulation using "SimDesign" package [@R-SimDesign]  with sample sizes varying from 50-350 and calculated average root mean squared error(RMSE) to estimate the optimal sample size for the graded response model with 23 items. The RMSE became stable for n = 200 to 300 (RMSE ranging between .25-.35). Our sample size within the estimated sample size for stability.


```{r}
fit <- mirt(EFA.data, model = 1, itemtype = 'graded', 
               SE = TRUE, Se.type = 'MHRM',
               technical = list(NCYCLES = 10000))


# Model Parameters ####
params <- coef(fit, IRTpars = TRUE, simplify = TRUE, rawug = FALSE) 
items <- data.frame(params$items)
se <- coef(fit, printSE = TRUE)

# Model Fit (degrees of freedom too low to check model fit)
model <- M2(fit)


#Item fit
item.fit<- itemfit(fit, fit_stats = c("S_X2", "G2","Zh", "infit"),
                                  impute=10)

#Identifying Missfit items based on RMSEA Value
item_misfits <- subset(item.fit, RMSEA.S_X2 >= .06)

# Person Fit ####

personfit <- personfit(fit) 
personfit_model_misfits <- subset(personfit, Zh < -2)
rownames(personfit_model_misfits)
nrow(personfit_model_misfits)
hist(personfit$Zh, xlab = "Zh Statistics",main = "F1 Person Fit")
abline(v = -2, lwd = 2, lty = 2)


# Plots ####

OCC <- plot(fit, type = "trace", facet =T, main = "Communication Scale OCC")
info <- plot(fit, type = "infoSE", main = "Communication Scale")
iteminfo <- plot(fit, type = "infotrace", 
                    facet_items = T, main = "Communication Scale")

item1<- plot(fit, type = "infotrace", 
                    facet_items = T, which.items = 1,main = "")
item1<- plot(fit, type = "infotrace", 
                    facet_items = T, which.items = 1,main = "")
item1<- plot(fit, type = "infotrace", 
                    facet_items = T, which.items = 1,main = "")



#conditional reliability
reliability <- plot(fit, type = 'rxx', theta_lim = c(-6, 6), 
      main="" )

marginal.rel <- marginal_rxx(fit)

#scale characteristics curve
scale <- plot(fit, type = 'score', theta_lim = c(-6, 6), main = "")

#-3<b<3
#.5<a<2; baker p12
```



```{r OCC, include=F}
ggicc <- function(model, item, theta){
  Theta <- matrix(seq(-theta,theta, by = .1))
  iteminfo <- mirt::extract.item(model, item)
  P <-mirt::probtrace(x=iteminfo , Theta=Theta  )
  icc <- data.frame(P = P, Theta = Theta)
  colnames(icc) <- c(paste("P", 1:ncol(P), sep=''), "Theta")
  icc2<- reshape(icc, direction='long', varying = paste("P", 1:ncol(P), sep=''), v.names = 'P',
                 times = paste("P", 1:ncol(P), sep=''))
  plot <- ggplot2::ggplot(icc2,aes(Theta,P, col =time))+geom_line()+xlab(expression(theta)) + 
    ylab(expression(P(theta)))+ theme(legend.title=element_blank())
  return(plot)
  
}

library(ggsci)

item01 <- ggicc(fit,1,6)+apatheme+ggtitle("item01")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))

item02 <- ggicc(fit,2,6)+apatheme+ggtitle("item02")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))



item03 <- ggicc(fit,3,6)+apatheme+ggtitle("item03")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item04 <- ggicc(fit,4,6)+apatheme+ggtitle("item04")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item05 <- ggicc(fit,5,6)+apatheme+ggtitle("item05")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item06 <- ggicc(fit,6,6)+apatheme+ggtitle("item06")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item07 <- ggicc(fit,7,6)+apatheme+ggtitle("item07")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item08 <- ggicc(fit,8,6)+apatheme+ggtitle("item08")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))




item09 <- ggicc(fit,9,6)+apatheme+ggtitle("item09")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item10 <- ggicc(fit,10,6)+apatheme+ggtitle("item10")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item11 <- ggicc(fit,11,6)+apatheme+ggtitle("item11")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))
ggsave("Figures/ideal_icc.png",item11 , width = 12, height = 8, dpi = 600, bg = "white")


item12 <- ggicc(fit,12,6)+apatheme+ggtitle("item12")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item13 <- ggicc(fit,13,6)+apatheme+ggtitle("item013")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item14 <- ggicc(fit,14,6)+apatheme+ggtitle("item14")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item15 <- ggicc(fit,15,6)+apatheme+ggtitle("item15")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item16 <- ggicc(fit,16,6)+apatheme+ggtitle("item16")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item17 <- ggicc(fit,17,6)+apatheme+ggtitle("item17")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item18 <- ggicc(fit,18,6)+apatheme+ggtitle("item18")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item19 <- ggicc(fit,19,6)+apatheme+ggtitle("item19")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item20 <- ggicc(fit,20,6)+apatheme+ggtitle("item20")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


item21 <- ggicc(fit,21,6)+apatheme+ggtitle("item21")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))

item22 <- ggicc(fit,22,6)+apatheme+ggtitle("item22")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))

item23 <- ggicc(fit,23,6)+apatheme+ggtitle("item23")+apatheme+scale_color_npg()+
  scale_y_continuous(breaks=c(0,.5,1), limits = c(0, 1))


ICC <- cowplot::plot_grid(item01, item02, item03, item04, item05, item06, item07, item08, item09,
                   item10, item11, item12, item13, item14, item15, item16, item17, item19,
                   item20, item21, item23,
                      labels = "AUTO",
                     ncol=4,  
                    label_size = 15, 
                     align = "v")


ggsave("Figures/ICC.png",ICC , width = 12, height = 12, dpi = 600, bg = "white")


problem.icc <- cowplot::plot_grid(item01, item02, item03,  item05, item08, item09,
                                  item10,  item13,  item16, item17,  item23,
                                  labels = "AUTO",
                                  ncol=4,  
                                  label_size = 15, 
                                  align = "v")

ggsave("Figures/problem.icc.png",problem.icc , width = 12, height = 8, dpi = 600, bg = "white")


good.icc <- cowplot::plot_grid( item04,  item06, item07,
                                item11, item12, item14, item15, item18, item19,
                               item20, item21, item22,
                                  labels = "AUTO",
                                  ncol=4,  
                                  label_size = 15, 
                                  align = "v")

ggsave("Figures/good.icc.png",good.icc , width = 12, height = 8, dpi = 600, bg = "white")



```



```{r item-plots, inclide =F}
pacman::p_load(reshape,ggsci)
Theta <- matrix(seq(-6,6, by = .1))

item1.extract<- extract.item(fit, 1)
item2.extract<- extract.item(fit, 2)
item3.extract<- extract.item(fit, 3)
item4.extract<- extract.item(fit, 4)
item5.extract<- extract.item(fit, 5)
item6.extract<- extract.item(fit, 6)
item7.extract<- extract.item(fit, 7)
item8.extract<- extract.item(fit, 8)
item9.extract<- extract.item(fit, 9)
item10.extract<-extract.item(fit, 10)
item11.extract<- extract.item(fit, 11)
item12.extract<- extract.item(fit, 12)
item13.extract<- extract.item(fit, 13)
item14.extract<- extract.item(fit, 14)
item15.extract<- extract.item(fit, 15)
item16.extract<- extract.item(fit, 16)
item17.extract<-extract.item(fit, 17)
item18.extract<- extract.item(fit, 18)
item19.extract<- extract.item(fit, 19)
item20.extract<- extract.item(fit, 20)
item21.extract<-extract.item(fit, 21)
item22.extract<- extract.item(fit, 22)
item23.extract<- extract.item(fit, 23)


item1 <- iteminfo(item1.extract, Theta)
item2 <- iteminfo(item2.extract, Theta)
item3 <- iteminfo(item3.extract, Theta)
item4 <- iteminfo(item4.extract, Theta)
item5 <- iteminfo(item5.extract, Theta)
item6 <- iteminfo(item6.extract, Theta)
item7 <- iteminfo(item7.extract, Theta)
item8 <- iteminfo(item8.extract, Theta)
item9 <- iteminfo(item9.extract, Theta)
item10 <- iteminfo(item10.extract, Theta)
item11 <- iteminfo(item11.extract, Theta)
item12 <- iteminfo(item12.extract, Theta)
item13 <- iteminfo(item13.extract, Theta)
item14 <- iteminfo(item14.extract, Theta)
item15 <- iteminfo(item15.extract, Theta)
item16 <- iteminfo(item16.extract, Theta)
item17 <- iteminfo(item17.extract, Theta)
item18 <- iteminfo(item18.extract, Theta)
item19 <- iteminfo(item19.extract, Theta)
item20 <- iteminfo(item20.extract, Theta)
item21 <- iteminfo(item21.extract, Theta)
item22 <- iteminfo(item22.extract, Theta)
item23 <- iteminfo(item23.extract, Theta)


info.data <- as.data.frame(cbind(item1, item2, item3,item4,item5,item6,item7,item8,item9,item10,
                                 item11,item12,item13,item14,item15,item16,item17,item18,item19,item20,
                                 item21,item22,item23))

item1.iic1 <- ggplot(info.data,aes(Theta,item1))+geom_line()+apatheme+
  ggtitle(" Item01")+theme(legend.position = "none")+ylim(0,.7)+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info

item2.iic1 <- ggplot(info.data,aes(Theta,item2))+geom_line()+apatheme+
  ggtitle(" Item02")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info

item3.iic1 <- ggplot(info.data,aes(Theta,item3))+geom_line()+apatheme+
  ggtitle(" Item03")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info

item4.iic1 <- ggplot(info.data,aes(Theta,item4))+geom_line()+apatheme+
  ggtitle(" Item04")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info

item5.iic1 <- ggplot(info.data,aes(Theta,item5))+geom_line()+apatheme+
  ggtitle(" Item05")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info


item6.iic1 <- ggplot(info.data,aes(Theta,item6))+geom_line()+apatheme+
  ggtitle(" Item06")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item7.iic1 <- ggplot(info.data,aes(Theta,item7))+geom_line()+apatheme+
  ggtitle(" Item07")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item8.iic1 <- ggplot(info.data,aes(Theta,item8))+geom_line()+apatheme+
  ggtitle(" Item08")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info

item9.iic1 <- ggplot(info.data,aes(Theta,item9))+geom_line()+apatheme+
  ggtitle(" Item09")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info

item10.iic1 <- ggplot(info.data,aes(Theta,item10))+geom_line()+apatheme+
  ggtitle(" Item10")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info


item11.iic1 <- ggplot(info.data,aes(Theta,item11))+geom_line()+apatheme+
  ggtitle(" Item11 ")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item12.iic1 <- ggplot(info.data,aes(Theta,item12))+geom_line()+apatheme+
  ggtitle(" Item12")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item13.iic1 <- ggplot(info.data,aes(Theta,item13))+geom_line()+apatheme+
  ggtitle(" Item13)")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info


item14.iic1 <- ggplot(info.data,aes(Theta,item14))+geom_line()+apatheme+
  ggtitle(" Item14")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item15.iic1 <- ggplot(info.data,aes(Theta,item15))+geom_line()+apatheme+
  ggtitle(" Item15 ")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item16.iic1 <- ggplot(info.data,aes(Theta,item16))+geom_line()+apatheme+
  ggtitle(" Item16")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info

item17.iic1 <- ggplot(info.data,aes(Theta,item17))+geom_line()+apatheme+
  ggtitle(" Item17")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info

item18.iic1 <- ggplot(info.data,aes(Theta,item18))+geom_line()+apatheme+
  ggtitle("Item18")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item19.iic1 <- ggplot(info.data,aes(Theta,item19))+geom_line()+apatheme+
  ggtitle(" Item19")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item20.iic1 <- ggplot(info.data,aes(Theta,item20))+geom_line()+apatheme+
  ggtitle(" Item20")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item21.iic1 <- ggplot(info.data,aes(Theta,item21))+geom_line()+apatheme+
  ggtitle(" Item21")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item22.iic1 <- ggplot(info.data,aes(Theta,item22))+geom_line()+apatheme+
  ggtitle(" Item22")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))

item23.iic1 <- ggplot(info.data,aes(Theta,item23))+geom_line()+apatheme+
  ggtitle(" Item23")+
  labs(y = "Item Information")+
  scale_color_npg()+geom_hline(yintercept = .20, colour ="red")+ylim(0,.7)+geom_area(fill ="palegreen4" )+
  xlab(expression(theta))+ ylab(expression(I(theta)))# Low info



ICC1 <- cowplot::plot_grid( item1.iic1, item2.iic1, item3.iic1, item4.iic1, item5.iic1, item8.iic1 ,  labels = "AUTO",ncol=2, label_size = 15,align = "v")
ggsave("Figures/ICC1.png",ICC1 , width = 12, height = 8, dpi = 600, bg = "white")


ICC2 <- cowplot::plot_grid( item9.iic1, item10.iic1, item13.iic1, item16.iic1, item17.iic1, item23.iic1 ,  labels = "AUTO",ncol=2, label_size = 15,align = "v")
ggsave("Figures/ICC2.png",ICC2 , width = 12, height = 8, dpi = 600, bg = "white")


ICC3 <- cowplot::plot_grid( item6.iic1, item7.iic1, item11.iic1, item12.iic1, item14.iic1, item15.iic1 ,  labels = "AUTO",ncol=2, label_size = 15,align = "v")
ggsave("Figures/ICC3.png",ICC3 , width = 12, height = 8, dpi = 600, bg = "white")


ICC4 <- cowplot::plot_grid( item18.iic1, item19.iic1, item20.iic1, item21.iic1, item22.iic1,  labels = "AUTO",ncol=2, label_size = 15,align = "v")
ggsave("Figures/ICC4.png",ICC4 , width = 12, height = 8, dpi = 600, bg = "white")


bad.info <- ICC1 <- cowplot::plot_grid( item1.iic1, item2.iic1, item3.iic1, item4.iic1, item5.iic1, item8.iic1 ,
                                        item9.iic1, item10.iic1, item13.iic1, item16.iic1, item17.iic1, item23.iic1 , 
                                        
                                        labels = "AUTO",ncol=3, 
                                        label_size = 15,align = "v")
ggsave("Figures/bad.info.png",bad.info, width = 12, height = 8, dpi = 600, bg = "white")


good.info <- cowplot::plot_grid( item6.iic1, item7.iic1, item11.iic1, item12.iic1, item14.iic1, item15.iic1 , item18.iic1, item19.iic1, item20.iic1, item21.iic1, item22.iic1, 
                                 labels = "AUTO",ncol=3, label_size = 15,align = "v")


ggsave("Figures/good.info.png",good.info, width = 12, height = 8, dpi = 600, bg = "white")



```



```{r IRT2, include}

irt.2 <- dplyr::select(EFA.data, -c(CS01,CS02,CS03,CS04, CS05,CS08, CS09, CS10, CS13, CS16, CS17,CS23))



fit2 <- mirt(irt.2, model = 1, itemtype = 'graded', 
               SE = TRUE, Se.type = 'MHRM',
               technical = list(NCYCLES = 10000))


occ <- plot(fit2, facet =T, type= "trace")


# Model Parameters ####
params2 <- coef(fit2, IRTpars = TRUE, simplify = TRUE, rawug = FALSE) 
items2 <- data.frame(params2$items)
se2 <- coef(fit2, printSE = TRUE)

# Model Fit (degrees of freedom too low to check model fit)
model2 <- as.data.frame(M2(fit2))


#Item fit
item.fit2<- itemfit(fit2, fit_stats = c("S_X2",  "infit"),
                                  impute=10)

#Identifying Missfit items based on RMSEA Value
item_misfits2 <- subset(item.fit2, RMSEA.S_X2 >= .06)


## Creating IRT table
item.fit3 <- item.fit2[,-c(1,2,4)] 
colnames(item.fit3) <- c("Outfit", "Infit", "S-Chi-square", "df", "RMSEA", "p")

IRT.details <- cbind(items2 ,item.fit3)

IRT.details <- IRT.details %>% 
 dplyr::mutate_if(is.numeric, round, digits=3)

IRT.details <- tibble::rownames_to_column(IRT.details, "Items")
#write_csv(IRT.details, "table_raw/IRT_parameters.csv")

#-3<b<3
#.5<a<2; baker p12

mean.discrimination <- mean(IRT.details$a)
sd.discrimination <- sd(IRT.details$a)
range.descrimination <- range(IRT.details$a)

cat.prob <- IRT.details[,c(3:6)]
cat.prob.long <- reshape::melt(cat.prob)
range.difficulty <- range(cat.prob.long$value)

range.outfit <-  range(IRT.details$Outfit)
range.infit <-  range(IRT.details$Infit)
range.rmsea <- range(IRT.details$RMSEA)


# Person Fit ####
personfit2 <- personfit(fit2) 
personfit_model_misfits2 <- subset(personfit2, Zh < -2)
rownames(personfit_model_misfits2)
nrow(personfit_model_misfits2)


person <- ggplot(personfit2, aes(x=Zh)) + geom_histogram(binwidth=.5,col=I("black"),fill="palegreen4")+geom_vline(xintercept = -2)+
  labs( y="Number of Participants", x = "Zh Statistics")+apatheme + xlim(-4,2)+
   scale_y_continuous(limits = c(0, 40), expand = expand_scale(mult = c(0, 0.1)))


annotation.1 <- data.frame(
   x = (-3.1),
   y = (20),
   label = ("Most of the participants
        are within the guidline")
)

per.anno <-person + geom_label(data=annotation.1, aes( x=x, y=y, label=label),                 , 
           color="orange", 
           size=5 , angle=45, fontface="bold" )


ggsave("Figures/person.png",per.anno , width = 12, height = 8, dpi = 600, bg = "white")

# Plots ####

OCC2 <- plot(fit2, type = "trace", facet =T, main = "Communication Scale OCC")
info2 <- plot(fit2, type = "infoSE", main = "Communication Scale")
iteminfo2 <- plot(fit2, type = "infotrace", 
                    facet_items = T, main = "Communication Scale")

##Test Info
info <- tabledown::ggtestinfo(irt.2, fit2)+apatheme+geom_line(colour = "black", size=1.5)+geom_area(fill ="palegreen4" )+geom_vline(xintercept = -3, colour ="black")+
  geom_vline(xintercept = .5, colour ="black")
library(plotly)
info.p <- plotly::ggplotly(info)

annotation <- data.frame(
   x = c(-4.2,1.5),
   y = c(4.5,4.3),
   label = c("Theta = -3", "Theta =.5")
)

info.anno <- info + geom_label(data=annotation, aes( x=x, y=y, label=label),
           color="orange", 
           size=7 , angle=45, fontface="bold" )

ggsave("Figures/TIC.png",info.anno  , width = 12, height = 8, dpi = 600, bg = "white")


#conditional reliability
library(latticeExtra)
library(directlabels)
font.settings <- list(
  font = 1,
  cex = 6,
  fontfamily = "sans")

apa.latice  <- list(
  par.xlab.text = font.settings,
  par.ylab.text = font.settings,
  axis.text = font.settings,
  sub.text = font.settings,
  add.text = font.settings)





reliability.focused <- plot(fit2, type = 'rxx', theta_lim = c(-4, 2), 
      main="Conditional Reliability Plot", par.settings=c(apa.latice),col.line = "#E69F00",lwd = 3.5 )






marginal.rel2 <- marginal_rxx(fit2)

#scale characteristics curve
scale2 <- plot(fit2, type = 'score', theta_lim = c(-6, 6), main = "")



```

```{r conrel-print, include=F}
##
png(filename="Figures/conrel.png", 
    type="cairo",
    units="in", 
    width=12, 
    height=8, 
    pointsize=12, 
    res=300)
plot(fit2, type = 'rxx', theta_lim = c(-6, 6), 
      main="", par.settings=c(apa.latice),col.line = "#E69F00",lwd = 3.5, cex =2.5 )+
  layer(panel.abline(v = -4, colour = "red",panel=panel.filled_smooth))+
  layer(panel.abline(v = 1.5))

dev.off()
```






Marginal reliability is based on the true score model (Lord & Novick, 1968) and is an estimate of the overall reliability of a test based on the average conditional standard errors. Often it is close in value to coefficient alpha (and sometimes it may even be identical). Alpha provides a lower estimate of marginal reliability.



```{r dif}
library("lordif")
DIF <- lordif(as.data.frame(irt.2), data$Sex, criterion = "Chisqr")
DIF$stats[,1:5]
plot(DIF)
```


## Participants

## Material

## Procedure

## Data analysis
We used `r cite_r("references.bib")` for all our analyses.


# Results

# Discussion


\newpage

# References

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id="refs" custom-style="Bibliography"></div>
\endgroup
